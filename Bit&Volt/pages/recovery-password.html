<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Recuperar Contraseña</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" type="logo" href="/assets/img-logos/pestana.png" />

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<nav class="navbar navbar-expand-lg navbar-light bg-primary fixed-top shadow-sm">
    <a class="navbar-brand ms-2" href="index.html">
        <img src="/assets/img-logos/logo-blanco.png" alt="Bit & Volt" style="height:38px;">
    </a>

    <button class="navbar-toggler text-white" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav">
        <i class="bi bi-list fs-1 text-white"></i>
    </button>

    <div class="collapse navbar-collapse" id="menuNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <button onclick="window.location.href='index.html'" class="btn me-2 mt-2 mt-lg-0 text-light">
                    <i class="bi bi-arrow-left"></i> Volver
                </button>
            </li>
        </ul>
    </div>
</nav>

<body>
    <br>

    <div class="d-flex align-items-center justify-content-center min-vh-100">
        <div class="login-card shadow-lg">
            <div class="row g-0">

                <!-- IZQUIERDA (Imagen decorativa) -->
                <div class="col-lg-6 d-none d-lg-flex align-items-center justify-content-center p-4">
                    <img src="/assets/img/olvidado.png" class="illustration img-fluid">
                </div>

                <!-- DERECHA -->
                <div class="col-lg-6 p-4 p-lg-5">

                    <!-- STEP 1: Comprobar correo -->
                    <div id="step1">
                        <br>
                        <h4 class="text-center mb-3 fw-bold">Comprobar correo</h4>
                        <img src="/assets/img/correo.png" style="width:40%;margin:auto;display:block;">

                        <p class="text-center text-muted mb-4">
                            Ingresa tu correo dos veces para verificar que coincide antes de enviar el código.
                        </p>

                        <div class="mb-3">
                            <label class="form-label">Correo electrónico</label>
                            <input id="email1" type="email" class="form-control" placeholder="correo@ejemplo.com">
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Confirmar correo</label>
                            <input id="email2" type="email" class="form-control" placeholder="Repite tu correo">
                        </div>

                        <button id="btnVerificar" class="btn btn-primary w-100">Continuar</button>
                    </div>

                    <!-- STEP 2: Enviar código -->
                    <div id="step2" class="d-none">
                        <br>
                        <h4 class="text-center mb-3 fw-bold">Enviar código</h4>
                        <img src="/assets/img/verificar.png" style="width:40%;margin:auto;display:block;">

                        <p class="text-center text-muted mt-3" id="correoCensuradoP"></p>

                        <p class="text-center text-muted">
                            Se enviará un email con un código a tu correo. Haz clic en el botón para enviarlo.
                        </p>

                        <button id="btnEnviarCorreo" class="btn btn-primary w-100">Enviar correo</button>
                    </div>

                    <!-- STEP 3: Verificar código -->
                    <div id="stepVerify" class="d-none text-center">
                        <br>
                        <h4 class="fw-bold mb-3">Verificar código</h4>
                        <img src="/assets/img/codigo.png" style="width:40%;margin:auto;display:block;">

                        <p class="text-muted mt-3" id="correoCensuradoVerify"></p>

                        <p class="text-muted">Escribe el código que enviamos a tu correo.</p>

                        <div class="code-container mt-3">
                            <input maxlength="1" id="c1" class="code-box"
                                style="border-radius:5px; border:2px solid #ff4db8; width:40px; height:40px;">
                            <input maxlength="1" id="c2" class="code-box"
                                style="border-radius:5px; border:2px solid #ff4db8; width:40px; height:40px;">
                            <input maxlength="1" id="c3" class="code-box"
                                style="border-radius:5px; border:2px solid #ff4db8; width:40px; height:40px;">
                            <input maxlength="1" id="c4" class="code-box"
                                style="border-radius:5px; border:2px solid #ff4db8; width:40px; height:40px;">
                        </div>

                        <button id="btnCheckCode" class="btn btn-primary w-100 mt-3">Verificar Código</button>

                        <a id="btnReenviar" class="d-block mt-3" style="cursor:pointer;">No recibí el código</a>
                    </div>

                    <!-- STEP 4: Cambiar contraseña -->
                    <div id="step3" class="d-none">
                        <br>
                        <h4 class="text-center mb-3 fw-bold">Cambiar contraseña</h4>
                        <img src="/assets/img/contrasena.png" style="width:40%;margin:auto;display:block;">

                        <p class="text-muted">Usa una contraseña segura: mínimo 8 caracteres, incluye mayúsculas,
                            minúsculas, números y un símbolo (Ej. MiClave!2024).</p>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Nueva contraseña</label>
                            <input id="newPass" type="password" class="form-control">
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Confirmar nueva contraseña</label>
                            <input id="newPass2" type="password" class="form-control">
                        </div>

                        <button id="btnCambiar" class="btn btn-primary w-100">Guardar contraseña</button>
                    </div>

                    <!-- MENSAJE -->
                    <div id="msgBox" class="alert d-none mt-3"></div>

                </div>
            </div>
        </div>
    </div>

<script>
    emailjs.init("lHC8uqfKLMIaACRs9");

    const CODE = "B7V2";

    // Obtener elementos
    const msgBox = document.getElementById("msgBox");
    const btnVerificar = document.getElementById("btnVerificar");
    const btnEnviarCorreo = document.getElementById("btnEnviarCorreo");
    const btnCheckCode = document.getElementById("btnCheckCode");
    const btnReenviar = document.getElementById("btnReenviar");
    const btnCambiar = document.getElementById("btnCambiar");

    const email1 = document.getElementById("email1");
    const email2 = document.getElementById("email2");

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const stepVerify = document.getElementById("stepVerify");
    const step3 = document.getElementById("step3");

    const c1 = document.getElementById("c1");
    const c2 = document.getElementById("c2");
    const c3 = document.getElementById("c3");
    const c4 = document.getElementById("c4");

    const newPass = document.getElementById("newPass");
    const newPass2 = document.getElementById("newPass2");

    function showMsg(text, type) {
        msgBox.className = `alert alert-${type}`;
        msgBox.innerText = text;
        msgBox.classList.remove("d-none");

        setTimeout(() => msgBox.classList.add("d-none"), 3000);
    }

    function censurarCorreo(email) {
        let [name, domain] = email.split("@");
        let inicio = name.slice(0, 3);
        return `${inicio}*********@${domain}`;
    }

    // PASO 1
    btnVerificar.addEventListener("click", () => {
        const e1 = email1.value.trim();
        const e2 = email2.value.trim();

        if (!e1 || !e2)
            return showMsg("Completa ambos campos", "danger");

        if (e1 !== e2)
            return showMsg("Los correos no coinciden", "danger");

        document.getElementById("correoCensuradoP").innerText =
            "Correo destino: " + censurarCorreo(e1);

        step1.classList.add("d-none");
        step2.classList.remove("d-none");
    });

    // PASO 2
    btnEnviarCorreo.addEventListener("click", () => {
        const email = email1.value;

        emailjs.send("service_1fsz21r", "template_z3wrjq9", { email })
            .then(() => {
                showMsg("Correo enviado", "success");

                document.getElementById("correoCensuradoVerify").innerText =
                    "Se envió a: " + censurarCorreo(email);

                step2.classList.add("d-none");
                stepVerify.classList.remove("d-none");
            })
            .catch(error => showMsg("Error: " + error.text, "danger"));
    });

    // PASO 3
    btnCheckCode.addEventListener("click", () => {
        const typed = c1.value + c2.value + c3.value + c4.value;

        if (typed.toUpperCase() !== CODE)
            return showMsg("Código incorrecto", "danger");

        showMsg("Código correcto ✔", "success");

        stepVerify.classList.add("d-none");
        step3.classList.remove("d-none");
    });

    btnReenviar.addEventListener("click", () => {
        stepVerify.classList.add("d-none");
        step2.classList.remove("d-none");
        showMsg("Código reenviado", "info");
    });

    // PASO 4 — Validación completa
    btnCambiar.addEventListener("click", () => {
        const pass = newPass.value;
        const pass2 = newPass2.value;

        if (pass.length < 8)
            return showMsg("La contraseña debe tener mínimo 8 caracteres", "danger");

        if (!/[A-Z]/.test(pass))
            return showMsg("La contraseña debe incluir al menos una letra mayúscula", "danger");

        if (!/[0-9!@#$%^&*()_\-+=?/{}[\]|.,]/.test(pass))
            return showMsg("La contraseña debe incluir al menos un número o símbolo especial", "danger");

        if (pass !== pass2)
            return showMsg("Las contraseñas no coinciden", "danger");

        showMsg("Contraseña cambiada correctamente ✔", "success");

        setTimeout(() => {
            window.location.href = "/pages/login.html";
        }, 2000);
    });
</script>


</body>

</html>